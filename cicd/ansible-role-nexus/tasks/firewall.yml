---
- name: Check for firewalld service status
  ansible.builtin.service_facts:
  register: service_facts
  ignore_errors: true
  #when: ansible_os_family == "RedHat" or ansible_os_family == "Fedora"

- name: Set firewall_type to firewalld if active
  ansible.builtin.set_fact:
    firewall_type: "firewalld"
  when:
    - service_facts is success
    - "'firewalld.service' in ansible_facts.services"
    - "ansible_facts.services['firewalld.service'].state == 'running'"

- name: Check for ufw status
  ansible.builtin.command: ufw status
  register: ufw_status
  ignore_errors: true
  changed_when: false
  when: firewall_type == "Unknown" and (ansible_os_family == "Debian" or ansible_os_family == "Ubuntu")

- name: Set firewall_type to ufw if active
  ansible.builtin.set_fact:
    firewall_type: "ufw"
  when:
    - firewall_type == "Unknown"
    - ufw_status is success
    - "'Status: active' in ufw_status.stdout"

# Iptables is usually a fallback/underlying technology, but specific management tools exist
- name: Check for iptables-persistent or other iptables management
  ansible.builtin.command: iptables -L -n
  register: iptables_rules
  ignore_errors: true
  changed_when: false
  when: firewall_type == "Unknown"

- name: Set firewall_type to iptables if rules are present and no other firewall was found
  ansible.builtin.set_fact:
    firewall_type: "iptables"
  # This is a heuristic; iptables -L usually returns something, so check for a non-empty output or a specific rule
  when:
    - firewall_type == "Unknown"
    - iptables_rules is success
    - iptables_rules.stdout | length > 0


- name: Display detected firewall type
  ansible.builtin.debug:
    msg: "Detected firewall type: {{ firewall_type }}"

